name: Deploy to Timeweb

on:
  workflow_dispatch:  # Ð¢Ð¾Ð»ÑŒÐºÐ¾ Ñ€ÑƒÑ‡Ð½Ð¾Ð¹ Ð·Ð°Ð¿ÑƒÑÐº
  # push:  # ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ð·Ð°Ð¿ÑƒÑÐº Ð¾Ñ‚ÐºÐ»ÑŽÑ‡ÐµÐ½ - Ð·Ð°Ð¿Ñ€Ð°ÑˆÐ¸Ð²Ð°ÐµÐ¼ Ñ€Ð°Ð·Ñ€ÐµÑˆÐµÐ½Ð¸Ðµ
  #   branches:
  #     - main

concurrency:
  group: deploy-prod
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Fresh deployment
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.TIMEWEB_HOST }}
          username: ${{ secrets.TIMEWEB_USER }}
          key: ${{ secrets.TIMEWEB_SSH_KEY }}
          command_timeout: 30m
          script: |
            # Clean up old deployment
            cd ~/Lec7.com 2>/dev/null && docker-compose down -v 2>/dev/null || true
            cd ~ && rm -rf Lec7.com 2>/dev/null || true
            docker system prune -af --volumes 2>/dev/null || true
            
            # Clone fresh project
            git clone https://github.com/zebvalera774583-maker/Lec7.com.git
            cd Lec7.com
            
            # Create .env
            cat > .env <<'ENVEOF'
            DATABASE_URL=postgresql://lec7:lec7_password@postgres:5432/lec7?schema=public
            NEXT_PUBLIC_APP_URL=http://194.87.104.179:3000
            JWT_SECRET=lec7-super-secret-jwt-key-minimum-32-characters-long-2024-change-in-production
            OPENAI_API_KEY=sk-your-openai-api-key-here
            S3_ENDPOINT=https://s3.timeweb.com
            S3_ACCESS_KEY_ID=your-timeweb-s3-access-key
            S3_SECRET_ACCESS_KEY=your-timeweb-s3-secret-key
            S3_BUCKET_NAME=lec7-storage
            S3_REGION=ru-1
            S3_PUBLIC_URL=https://lec7-storage.s3.timeweb.com
            ENVEOF
            
            # Build and start
            docker-compose up -d --build
            
            # Wait for postgres
            sleep 15
            
            # Run migrations
            docker-compose exec -T app npx prisma migrate deploy || echo "âš ï¸  Migrations skipped"
            
            # Show status
            echo "ðŸ“Š Container status:"
            docker-compose ps
            echo ""
            echo "ðŸ“‹ App logs (last 10 lines):"
            docker-compose logs --tail=10 app || echo "âš ï¸  App not running"
