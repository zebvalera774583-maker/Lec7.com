name: Deploy to Timeweb

on:
  workflow_dispatch:  # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ GitHub UI
  push:  # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –¥–µ–ø–ª–æ–π –ø—Ä–∏ push –≤ main
    branches:
      - main

concurrency:
  group: deploy-prod
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Deploy to server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.TIMEWEB_HOST }}
          username: ${{ secrets.TIMEWEB_USER }}
          key: ${{ secrets.TIMEWEB_SSH_KEY }}
          command_timeout: 30m
          script: |
            echo "üöÄ Starting deployment..."
            
            # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
            cd ~/Lec7.com || {
              echo "‚ö†Ô∏è  Project directory not found, cloning..."
              cd ~
              git clone https://github.com/zebvalera774583-maker/Lec7.com.git
              cd Lec7.com
            }
            
            # –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥
            echo "üì• Pulling latest code..."
            git pull || {
              echo "‚ö†Ô∏è  Git pull failed, trying to reset..."
              git fetch origin
              git reset --hard origin/main
            }
            
            # –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ —Å–∫—Ä–∏–ø—Ç—ã –¥–µ–ø–ª–æ—è –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–µ
            chmod +x scripts/deploy.sh scripts/deploy-simple.sh deploy-simple.sh 2>/dev/null || true
            
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–∫—Ä–∏–ø—Ç –¥–µ–ø–ª–æ—è (–µ—Å–ª–∏ –µ—Å—Ç—å) –∏–ª–∏ –≤—ã–ø–æ–ª–Ω—è–µ–º –∫–æ–º–∞–Ω–¥—ã –Ω–∞–ø—Ä—è–º—É—é
            if [ -f scripts/deploy-simple.sh ]; then
              echo "üì¶ Using deploy-simple.sh script..."
              bash scripts/deploy-simple.sh
            else
              echo "üì¶ Running deployment commands..."
              
              # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
              echo "üõë Stopping containers..."
              docker-compose down || true
              
              # –°–æ–±–∏—Ä–∞–µ–º –∏ –∑–∞–ø—É—Å–∫–∞–µ–º
              echo "üî® Building and starting containers..."
              docker-compose build app
              docker-compose up -d
              
              # –ñ–¥—ë–º –∑–∞–ø—É—Å–∫–∞ –ë–î
              echo "‚è≥ Waiting for database..."
              sleep 15
              
              # –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏
              echo "üìä Running database migrations..."
              docker-compose exec -T app npx prisma migrate deploy || echo "‚ö†Ô∏è  Migrations skipped"
            fi
            
            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å
            echo ""
            echo "‚úÖ Deployment complete!"
            echo ""
            echo "üìä Container status:"
            docker-compose ps
            echo ""
            echo "üìã App logs (last 20 lines):"
            docker-compose logs --tail=20 app || echo "‚ö†Ô∏è  App not running"
