# Миграция slug'ов на латиницу

## Описание

Этот скрипт мигрирует существующие slug'и бизнесов с кириллицы на латиницу, используя транслитерацию.

## Запуск на сервере (Timeweb/SSH)

### Вариант 1: Через npx tsx (рекомендуется)

```bash
cd /path/to/lec7.com
npx tsx scripts/migrate-slugs-to-latin.ts
```

### Вариант 2: Через ts-node

```bash
cd /path/to/lec7.com
npx ts-node scripts/migrate-slugs-to-latin.ts
```

### Вариант 3: Скомпилировать и запустить

```bash
cd /path/to/lec7.com
npx tsc scripts/migrate-slugs-to-latin.ts --outDir /tmp --esModuleInterop --module commonjs --target es2020
node /tmp/scripts/migrate-slugs-to-latin.js
```

## Что делает скрипт

1. Находит все бизнесы с slug'ами, содержащими не-ASCII символы (кириллицу)
2. Для каждого бизнеса:
   - Транслитерирует название в латиницу
   - Генерирует новый slug (только a-z0-9-)
   - Проверяет уникальность (добавляет суффикс -1, -2, ... если нужно)
   - Обновляет slug в базе данных

## Примеры транслитерации

- "Валерий Зебелян" → "valeriy-zebelyan"
- "Москва" → "moskva"
- "Санкт-Петербург" → "sankt-peterburg"

## Важно

- Скрипт **безопасен**: он не удаляет данные, только обновляет slug'и
- Скрипт **идемпотентен**: можно запускать несколько раз (пропустит уже латинские slug'и)
- После миграции старые URL с кириллицей (`/~кириллица`) будут возвращать 404
- Новые URL с латиницей (`/~latin-slug`) будут работать

## Проверка после миграции

1. Проверьте, что все ACTIVE бизнесы доступны по новым URL:
   ```bash
   curl -I https://lec7.com/~new-slug
   ```

2. Проверьте, что старые URL возвращают 404:
   ```bash
   curl -I https://lec7.com/~старый-слаг
   ```

3. Проверьте в базе данных:
   ```sql
   SELECT id, name, slug FROM "Business" WHERE slug ~ '[^a-z0-9-]';
   ```
   (должно вернуть 0 строк)

## Когда запускать

- **Один раз** после деплоя изменений
- **Не** запускать на каждом старте приложения
- Добавить в чеклист деплоя

## Откат (если нужно)

Если нужно откатить миграцию, используйте бэкап базы данных, сделанный перед миграцией.
