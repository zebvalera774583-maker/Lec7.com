generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String?
  avatarUrl String?
  role      String   @default("BUSINESS_OWNER") // BUSINESS_OWNER | LEC7_ADMIN
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  businesses         Business[]          @relation("BusinessOwner")
  ownerConversations OwnerConversation[]
  auditLogs          AuditLog[]
  conversations      Conversation[]
  agentConversations AgentConversation[] @relation("AgentConversations")
}

model Business {
  id              String   @id @default(cuid())
  name            String
  slug            String   @unique
  description     String?
  city            String?
  category        String?
  logoUrl         String?
  coverUrl        String?
  ownerId         String
  lifecycleStatus String   @default("DRAFT") // DRAFT | ACTIVE | SUSPENDED | ARCHIVED
  billingStatus   String   @default("UNPAID") // UNPAID | PAID | TRIAL | EXPIRED
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  owner      User             @relation("BusinessOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  portfolios Portfolio[]
  requests   Request[]
  invoices   Invoice[]
  events     Event[]
  profile    BusinessProfile?
  photos     BusinessPhoto[]
  portfolioItems BusinessPortfolioItem[]
  conversations   Conversation[]
  agentConversations AgentConversation[] @relation("AgentConversations")
  priceLists      PriceList[]
  assignedPrices  PriceAssignment[] @relation("AssignedPrices")
}

model BusinessProfile {
  id              String   @id @default(cuid())
  businessId      String   @unique
  displayName     String?
  avatarUrl       String?
  phone           String?
  telegramUsername String?
  residentNumber  String?  @unique
  statsCases      Int      @default(40)
  statsProjects   Int      @default(2578)
  statsCities     Int      @default(4)
  cities          String[]
  services        String[]
  servicesRaw     String?  // Сырой текст услуг от пользователя (до структурирования AI)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId])
}

model BusinessPhoto {
  id         String   @id @default(cuid())
  businessId String
  url        String
  sortOrder  Int      @default(0)
  createdAt  DateTime @default(now())

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId])
  @@index([sortOrder])
}

model BusinessPortfolioItem {
  id         String   @id @default(cuid())
  businessId String
  title      String?
  comment    String?
  coverUrl   String?
  sortOrder  Int      @default(0)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  business Business              @relation(fields: [businessId], references: [id], onDelete: Cascade)
  photos   BusinessPortfolioPhoto[]

  @@index([businessId])
  @@index([sortOrder])
}

model BusinessPortfolioPhoto {
  id         String   @id @default(cuid())
  itemId     String
  url        String
  sortOrder  Int      @default(0)
  createdAt  DateTime @default(now())

  item BusinessPortfolioItem @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@index([itemId])
  @@index([sortOrder])
}

model Portfolio {
  id          String   @id @default(cuid())
  businessId  String
  title       String
  description String?
  imageUrl    String
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId])
}

model Request {
  id          String   @id @default(cuid())
  businessId  String
  title       String
  description String
  clientName  String?
  clientEmail String?
  clientPhone String?
  source      String   @default("ai_chat")
  status      String   @default("NEW") // NEW | IN_PROGRESS | COMPLETED | CANCELLED
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  business Business? @relation(fields: [businessId], references: [id], onDelete: Cascade)
  invoices Invoice[]

  @@index([businessId])
}

model Invoice {
  id          String    @id @default(cuid())
  businessId  String
  requestId   String?
  number      String
  clientName  String
  clientEmail String?
  clientPhone String?
  amount      Decimal   @db.Decimal(10, 2)
  currency    String    @default("RUB")
  status      String    @default("DRAFT") // DRAFT | SENT | PAID | CANCELLED
  dueDate     DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  business Business? @relation(fields: [businessId], references: [id], onDelete: Cascade)
  request  Request?  @relation(fields: [requestId], references: [id], onDelete: SetNull)

  @@index([businessId])
  @@index([requestId])
}

model Event {
  id          String   @id @default(cuid())
  businessId  String
  type        String // EVENT_TYPE
  title       String
  description String?
  metadata    Json?
  createdAt   DateTime @default(now())

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId])
  @@index([type])
}

model Document {
  id         String   @id @default(cuid())
  businessId String?
  invoiceId  String?
  type       String // INVOICE_PDF | CONTRACT | OTHER
  fileName   String
  fileUrl    String
  mimeType   String?
  size       Int?
  createdAt  DateTime @default(now())

  @@index([businessId])
  @@index([invoiceId])
}

model BusinessUser {
  id         String   @id @default(cuid())
  businessId String
  userId     String
  role       String   @default("MEMBER")
  createdAt  DateTime @default(now())

  @@unique([businessId, userId])
  @@index([businessId])
  @@index([userId])
}

model OwnerConversation {
  id        String   @id @default(cuid())
  userId    String
  title     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user     User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages OwnerMessage[]

  @@index([userId])
}

model OwnerMessage {
  id             String   @id @default(cuid())
  conversationId String
  role           String // 'user' | 'assistant'
  content        String
  createdAt      DateTime @default(now())

  conversation OwnerConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String?
  action    String
  metadata  Json?
  createdAt DateTime @default(now())

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([action])
}

model AgentPlaybookItem {
  id         String   @id @default(cuid())
  scope      String // PLATFORM | BUSINESS
  businessId String?
  title      String
  move       String
  context    String?
  outcome    String?
  confidence String // LOW | MEDIUM | HIGH
  tags       String[]
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([scope])
  @@index([businessId])
  @@index([confidence])
}

model Conversation {
  id         String   @id @default(cuid())
  userId     String
  intent     String // 'owner' | 'resident_marketing'
  businessId String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  business  Business? @relation(fields: [businessId], references: [id], onDelete: Cascade)
  messages  Message[]

  @@index([userId])
  @@index([businessId])
  @@index([intent])
}

model Message {
  id             String   @id @default(cuid())
  conversationId String
  role           String // 'user' | 'assistant'
  content        String
  createdAt      DateTime @default(now())

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([role])
}

// === Agent (Chat) ===

enum AgentScope {
  PLATFORM
  BUSINESS
  PUBLIC
}

enum AgentMode {
  CREATOR
  RESIDENT
  CLIENT
}

enum AgentMessageRole {
  USER
  ASSISTANT
  SYSTEM
  TOOL
}

model AgentConversation {
  id        String     @id @default(cuid())
  title     String?
  scope     AgentScope
  mode      AgentMode  @default(CREATOR)

  // кто ведёт разговор (авторизованный пользователь платформы)
  userId    String
  user      User       @relation("AgentConversations", fields: [userId], references: [id], onDelete: Cascade)

  // привязка к бизнесу (если scope=BUSINESS). Для PLATFORM/PUBLIC будет null.
  businessId String?
  business   Business? @relation("AgentConversations", fields: [businessId], references: [id], onDelete: Cascade)

  messages  AgentMessage[]

  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  @@index([userId, updatedAt])
  @@index([scope, businessId, updatedAt])
}

model AgentMessage {
  id             String            @id @default(cuid())
  conversationId String
  conversation   AgentConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  role           AgentMessageRole
  content        String

  // метаданные (токены, модель, latency, toolCalls и т.п.)
  meta           Json?

  createdAt      DateTime          @default(now())

  @@index([conversationId, createdAt])
}

// === Price Lists ===

enum PriceListKind {
  BASE
  DERIVED
}

enum PriceModifierType {
  MARKUP
  DISCOUNT
}

model PriceList {
  id            String            @id @default(cuid())
  businessId    String
  name          String            // "Прайс 1", "Прайс 2"
  kind          PriceListKind     @default(BASE)
  derivedFromId String?
  modifierType PriceModifierType?
  percent       Int?               // Процент наценки/скидки (0-999)
  columns       Json?              // Структура колонок (для добавленных столбцов)
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  business          Business          @relation(fields: [businessId], references: [id], onDelete: Cascade)
  derivedFrom       PriceList?       @relation("DerivedPrices", fields: [derivedFromId], references: [id], onDelete: SetNull)
  derivedPrices     PriceList[]      @relation("DerivedPrices")
  rows               PriceListRow[]
  assignments        PriceAssignment[]

  @@index([businessId])
  @@index([derivedFromId])
}

model PriceListRow {
  id             String    @id @default(cuid())
  priceListId    String
  order          Int       // № п/п (1, 2, 3...)
  name           String    // Наименование
  unit           String?   // Ед. изм
  priceWithVat   Decimal?  @db.Decimal(12, 2)
  priceWithoutVat Decimal? @db.Decimal(12, 2)
  extra          Json?     // Для добавленных колонок
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  priceList PriceList @relation(fields: [priceListId], references: [id], onDelete: Cascade)

  @@unique([priceListId, order])
  @@index([priceListId])
}

model PriceAssignment {
  id                    String    @id @default(cuid())
  priceListId           String
  counterpartyBusinessId String
  createdAt             DateTime  @default(now())

  priceList           PriceList @relation(fields: [priceListId], references: [id], onDelete: Cascade)
  counterpartyBusiness Business @relation("AssignedPrices", fields: [counterpartyBusinessId], references: [id], onDelete: Cascade)

  @@unique([priceListId, counterpartyBusinessId])
  @@index([priceListId])
  @@index([counterpartyBusinessId])
}
