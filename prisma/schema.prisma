generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id         String   @id @default(cuid())
  email      String   @unique
  password   String
  name       String?
  role       String   @default("BUSINESS_OWNER") // BUSINESS_OWNER | LEC7_ADMIN
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  businesses        Business[]        @relation("BusinessOwner")
  ownerConversations OwnerConversation[]
  auditLogs         AuditLog[]
}

model Business {
  id             String   @id @default(cuid())
  name           String
  slug           String   @unique
  description    String?
  city           String?
  category       String?
  logoUrl        String?
  coverUrl       String?
  ownerId        String
  lifecycleStatus String  @default("DRAFT") // DRAFT | ACTIVE | SUSPENDED | ARCHIVED
  billingStatus  String   @default("UNPAID") // UNPAID | PAID | TRIAL | EXPIRED
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  owner     User       @relation("BusinessOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  portfolios Portfolio[]
  requests   Request[]
  invoices   Invoice[]
  events     Event[]
  profile   BusinessProfile?
}

model BusinessProfile {
  id           String   @id @default(cuid())
  businessId   String   @unique
  displayName  String?
  avatarUrl    String?
  statsCases   Int      @default(40)
  statsProjects Int     @default(2578)
  statsCities  Int      @default(4)
  cities       String[]
  services     String[]
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId])
}

model Portfolio {
  id          String   @id @default(cuid())
  businessId  String
  title       String
  description String?
  imageUrl    String
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId])
}

model Request {
  id          String   @id @default(cuid())
  businessId  String
  title       String
  description String
  clientName  String?
  clientEmail String?
  clientPhone String?
  source      String   @default("ai_chat")
  status      String   @default("NEW") // NEW | IN_PROGRESS | COMPLETED | CANCELLED
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  business Business? @relation(fields: [businessId], references: [id], onDelete: Cascade)
  invoices Invoice[]

  @@index([businessId])
}

model Invoice {
  id          String    @id @default(cuid())
  businessId  String
  requestId   String?
  number      String
  clientName  String
  clientEmail String?
  clientPhone String?
  amount      Decimal   @db.Decimal(10, 2)
  currency    String    @default("RUB")
  status      String    @default("DRAFT") // DRAFT | SENT | PAID | CANCELLED
  dueDate     DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  business Business? @relation(fields: [businessId], references: [id], onDelete: Cascade)
  request  Request?  @relation(fields: [requestId], references: [id], onDelete: SetNull)

  @@index([businessId])
  @@index([requestId])
}

model Event {
  id          String   @id @default(cuid())
  businessId  String
  type        String   // EVENT_TYPE
  title       String
  description String?
  metadata    Json?
  createdAt   DateTime @default(now())

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId])
  @@index([type])
}

model Document {
  id          String   @id @default(cuid())
  businessId  String?
  invoiceId   String?
  type        String   // INVOICE_PDF | CONTRACT | OTHER
  fileName    String
  fileUrl     String
  mimeType    String?
  size        Int?
  createdAt   DateTime @default(now())

  @@index([businessId])
  @@index([invoiceId])
}

model BusinessUser {
  id         String   @id @default(cuid())
  businessId String
  userId     String
  role       String   @default("MEMBER")
  createdAt  DateTime @default(now())

  @@unique([businessId, userId])
  @@index([businessId])
  @@index([userId])
}

model OwnerConversation {
  id        String   @id @default(cuid())
  userId    String
  title     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user     User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages OwnerMessage[]

  @@index([userId])
}

model OwnerMessage {
  id             String   @id @default(cuid())
  conversationId String
  role           String   // 'user' | 'assistant'
  content        String
  createdAt      DateTime @default(now())

  conversation OwnerConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String?
  action    String
  metadata  Json?
  createdAt DateTime @default(now())

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([action])
}

model AgentPlaybookItem {
  id         String   @id @default(cuid())
  scope      String   // PLATFORM | BUSINESS
  businessId String?
  title      String
  move       String
  context    String?
  outcome    String?
  confidence String   // LOW | MEDIUM | HIGH
  tags       String[]
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([scope])
  @@index([businessId])
  @@index([confidence])
}
