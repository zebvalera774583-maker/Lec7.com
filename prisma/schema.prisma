generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id         String   @id @default(cuid())
  email      String   @unique
  password   String
  name       String?
  role       String   @default("BUSINESS_OWNER") // BUSINESS_OWNER | LEC7_ADMIN
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  businesses Business[] @relation("BusinessOwner")
}

model Business {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  description String?
  city        String?
  category    String?
  logoUrl     String?
  coverUrl    String?
  ownerId     String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  owner     User       @relation("BusinessOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  portfolios Portfolio[]
  requests   Request[]
  invoices   Invoice[]
  events     Event[]
}

model Portfolio {
  id          String   @id @default(cuid())
  businessId  String
  title       String
  description String?
  imageUrl    String
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId])
}

model Request {
  id          String   @id @default(cuid())
  businessId  String
  title       String
  description String
  clientName  String?
  clientEmail String?
  clientPhone String?
  source      String   @default("ai_chat")
  status      String   @default("NEW") // NEW | IN_PROGRESS | COMPLETED | CANCELLED
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  business Business? @relation(fields: [businessId], references: [id], onDelete: Cascade)
  invoices Invoice[]

  @@index([businessId])
}

model Invoice {
  id          String    @id @default(cuid())
  businessId  String
  requestId   String?
  number      String
  clientName  String
  clientEmail String?
  clientPhone String?
  amount      Decimal   @db.Decimal(10, 2)
  currency    String    @default("RUB")
  status      String    @default("DRAFT") // DRAFT | SENT | PAID | CANCELLED
  dueDate     DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  business Business? @relation(fields: [businessId], references: [id], onDelete: Cascade)
  request  Request?  @relation(fields: [requestId], references: [id], onDelete: SetNull)

  @@index([businessId])
  @@index([requestId])
}

model Event {
  id          String   @id @default(cuid())
  businessId  String
  type        String   // EVENT_TYPE
  title       String
  description String?
  metadata    Json?
  createdAt   DateTime @default(now())

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId])
  @@index([type])
}

model Document {
  id          String   @id @default(cuid())
  businessId  String?
  invoiceId   String?
  type        String   // INVOICE_PDF | CONTRACT | OTHER
  fileName    String
  fileUrl     String
  mimeType    String?
  size        Int?
  createdAt   DateTime @default(now())

  @@index([businessId])
  @@index([invoiceId])
}

model BusinessUser {
  id         String   @id @default(cuid())
  businessId String
  userId     String
  role       String   @default("MEMBER")
  createdAt  DateTime @default(now())

  @@unique([businessId, userId])
  @@index([businessId])
  @@index([userId])
}
